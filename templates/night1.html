<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Die erste Nacht</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            display: flex;
        }
        .left-panel, .right-panel {
            height: 100vh;
            overflow-y: auto;
        }
        .left-panel {
            width: 30%;
            background-color: #f4f4f4;
            border-right: 1px solid #ccc;
            padding: 10px;
        }
        .right-panel {
            width: 70%;
            padding: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #f4f4f4;
        }
        img {
            width: 50px;
            height: 50px;
            border-radius: 5px;
        }
        .interactive-phase {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        .interactive-phase.active {
            display: block;
        }
        /* Neue CSS-Regel für die Spalte der ursprünglichen Rolle */
        table td:nth-child(4) {
            width: 60px;
            text-align: center;
        }
    </style>
</head>
<body>
    <script>
        // Spieler-ID des Diebs (dynamisch aus dem Backend übergeben)
        const CURRENT_PLAYER_ID = "{{ thief_player_id | default('null') }}";
    </script>

    <div class="left-panel">
        <table id="playersTable">
            <thead>
                <tr>
                    <th>Bild</th>
                    <th>Name</th>
                    <th>Aktuelle Rolle</th>
                    <th>Ursprüngliche Rolle</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for player in players %}
                <tr>
                    <td><img src="{{ player.image }}" alt="{{ player.name }}" width="50"></td>
                    <td>{{ player.name }}</td>
                    <td>{{ player.current_role or 'Keine Rolle' }}</td>
                    <td>
                        {% if player.original_role_image %}
                            <img src="{{ player.original_role_image }}" alt="{{ player.original_role }}" width="50">
                        {% else %}
                            Keine Rolle
                        {% endif %}
                    </td>
                    <td>{{ player.status }}</td>
                    <td>
                        <button onclick="killPlayer({{ player.id }})" 
                                style="background-color: red; color: white; border: none; padding: 5px 10px; border-radius: 5px;">
                            Töten
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>                     
        </table>        
    </div>
    <div class="right-panel">
        <div id="interactivePhase" class="interactive-phase">
            <h2 id="roleTitle">Rollenaktion</h2>
            <div id="roleContent">
                <!-- Dynamische Inhalte für die aktuelle Rolle -->
            </div>
            <div>
                <button onclick="previousAction()">Zurück</button>
                <button onclick="completeAction()">Aktion abschließen</button>
                <button onclick="updatePlayerTable()">Tabelle aktualisieren</button>
            </div>
        </div>
    </div>

    <script>
        let currentRoleIndex = 0;
        let roles = [];

        document.addEventListener('DOMContentLoaded', () => {
            fetchRoles();
        });

        async function fetchRoles() {
            const response = await fetch('/next_role');
            roles = await response.json();
            if (roles.length > 0) {
                loadRole(roles[currentRoleIndex]);
            }
        }

        function loadRole(role) {
    const phaseDiv = document.getElementById('interactivePhase');
    phaseDiv.classList.add('active');
    document.getElementById('roleTitle').textContent = `Rollenaktion: ${role.role_name}`;
    const roleContentDiv = document.getElementById('roleContent');
    roleContentDiv.innerHTML = ''; // Lösche alte Inhalte

    if (role.role_name === 'Dieb') {
        loadThiefPhase();
    } else {
        roleContentDiv.textContent = `Aktion für die Rolle ${role.role_name} wird ausgeführt.`;
    }
}


function loadThiefPhase() {
    fetch('/get_thief_cards')
        .then(response => response.json())
        .then(data => {
            const thiefCards = data.cards;
            const roleContentDiv = document.getElementById('roleContent');
            roleContentDiv.innerHTML = '<h3>Wähle eine Karte</h3>';
            thiefCards.forEach(card => {
                const button = document.createElement('button');
                button.style.border = "none";
                button.style.background = "none";
                button.onclick = () => chooseThiefCard(card.role_name);

                const img = document.createElement('img');
                img.src = card.image_path;
                img.alt = card.role_name;
                img.style.width = "100px";
                img.style.margin = "10px";

                button.appendChild(img);
                roleContentDiv.appendChild(button);
            });
        });
}



function chooseThiefCard(roleName) {
    fetch('/set_role_action', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            game_id: 1,
            role_name: 'Dieb',
            player_id: CURRENT_PLAYER_ID,
            action_name: 'Wähle neue Rolle',
            new_role: roleName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert(data.message);
            updatePlayerTable(); // Aktualisiere die Tabelle
            completeAction();
        }
    })
    .catch(error => console.error("Fehler:", error));
}




function completeAction() {
    currentRoleIndex++;
    if (currentRoleIndex < roles.length) {
        loadRole(roles[currentRoleIndex]); // Lade die nächste Rollenaktion
    } else {
        alert('Die Nacht ist vorbei!');
        location.reload(); // Seite neu laden, wenn alle Aktionen abgeschlossen sind
    }

    updatePlayerTable(); // Tabelle aktualisieren
}


function previousAction() {
    if (currentRoleIndex > 0) {
        currentRoleIndex--;
        loadRole(roles[currentRoleIndex]);
    } else {
        alert('Keine vorherige Aktion vorhanden.');
    }
}


function updatePlayerTable() {
    fetch('/players')
        .then(response => response.json())
        .then(data => {
            const tbody = document.querySelector('#playersTable tbody');
            tbody.innerHTML = ''; // Entferne alte Einträge

            data.forEach(player => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><img src="${player.image}" alt="${player.name}" width="50"></td>
                    <td>${player.name}</td>
                    <td>${player.current_role || 'Keine Rolle'}</td>
                    <td>
                        ${player.original_role_image 
                            ? `<img src="${player.original_role_image}" alt="${player.original_role}" width="50">` 
                            : 'Keine Rolle'}
                    </td>
                    <td>${player.status || 'Unbekannt'}</td>
                    <td>
                        <button onclick="killPlayer(${player.id})" 
                                style="background-color: red; color: white; border: none; padding: 5px 10px; border-radius: 5px;">
                            Töten
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        })
        .catch(error => console.error('Fehler beim Aktualisieren der Tabelle:', error));
}



function killPlayer(playerId) {
    if (!confirm('Möchtest du diesen Spieler wirklich töten?')) {
        return; // Aktion abbrechen
    }

    fetch('/kill_player', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ player_id: playerId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert(data.message);
            updatePlayerTable(); // Tabelle aktualisieren
        } else if (data.error) {
            alert(`Fehler: ${data.error}`);
        }
    })
    .catch(error => console.error('Fehler beim Töten des Spielers:', error));
}






    </script>
</body>
</html>
